trigger:
  branches:
    include:
      - main

pool:
  name: 'devops-vm-pool'

variables:
  JAVA_HOME_PATH: '/usr/lib/jvm/java-17-openjdk-amd64'

steps:
  - script: |
      echo "JAVA_HOME: $(JAVA_HOME_PATH)"
      export JAVA_HOME=$(JAVA_HOME_PATH)
      java -version
      mvn -version
    displayName: 'Verify Java and Maven'

  - script: |
      export JAVA_HOME=$(JAVA_HOME_PATH)
      mvn clean package -B
    displayName: 'Maven Build and Test'

  - task: PublishTestResults@2
    displayName: 'Publish Test Results'
    inputs:
      testResultsFormat: 'JUnit'
      testResultsFiles: '**/TEST-*.xml'
      searchFolder: '$(System.DefaultWorkingDirectory)'
    condition: always()

  - task: CopyFiles@2
    displayName: 'Copy JAR to staging'
    inputs:
      SourceFolder: 'target'
      Contents: '*.jar'
      TargetFolder: '$(Build.ArtifactStagingDirectory)'

  - task: PublishBuildArtifacts@1
    displayName: 'Publish Artifact'
    inputs:
      PathtoPublish: '$(Build.ArtifactStagingDirectory)'
      ArtifactName: 'greeting-api-$(Build.BuildId)'
      publishLocation: 'Container'